name: "💩 New content BotqaBoqBot notification"

on:
  push:
    branches:
      - 'feat/tg-bot'
      - main

jobs:
  new-post:
    name: 📄 New Post
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout the branch
        uses: actions/checkout@v3
        
      - name: 🔩 Install deps
        working-directory: ./.github
        run: npm install

      - name: 🔍 Find new post
        id: "find-new-post"
        working-directory: ./.github/workflows
        run: yarn zx './findNewPost.mjs'
        env:
          SHA: ${{ github.sha }}

    outputs:
      link: ${{ steps.find-new-post.outputs.link }}

  bot:
    if: ${{ needs.new-post.outputs.link != '' }}
    name: 💩 Botqa Bot notification
    needs: new-post
    runs-on: ubuntu-latest
    steps:
      - name: ⬇️ Checkout the branch
        uses: actions/checkout@v3

      - name: 👷 Setup node
        uses: actions/setup-node@v3

      - name: 🏃‍♂️ Install deps
        working-directory: ./.github
        run: npm install

      - name: 🏃 Bot script run
        working-directory: ./.github/workflows
        run: node notification.mjs
        env:
          TG_TOKEN: ${{secrets.TG_TOKEN}}
          TG_CHAT_ID: ${{secrets.TG_CHAT_ID}}
          LINK: ${{ needs.new-post.outputs.link }}
